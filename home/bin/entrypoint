#!/usr/bin/env sh
## Entrypoint Script

set -E

## Set environment.
CMD="lightningd"
CONF="/config/lightningd.conf"
DATA="/root/.lightning"

gen_keystr() {
  KEYS_FILE="$DATA/sparko.keys"
  for key in "$(cat $KEYS_FILE)"; do
    val="$(printf "$key" | awk -F '=' '{ print $2 }')"
    keystr="${keystr}${val}"
  done
  printf %s "$keystr" | tr '\n' '\;'
}

gen_logstr() {
  LOGIN_FILE="$DATA/sparko.login"
  SPARK_USER=`cat $LOGIN_FILE | kgrep USERNAME`
  SPARK_PASS=`cat $LOGIN_FILE | kgrep PASSWORD`
  printf %s "$SPARK_USER:$SPARK_PASS"
}

## Ensure bin files are executable.
for FILE in $PWD/bin/* ; do chmod a+x $FILE; done

## Check if binary exists.
[ -z "$(which $CMD)" ] && (echo "$CMD file is missing!" && exit 1)

## Check if sparko credentials exist.
if [ ! -f "$DATA/sparko.keys" ] || [ ! -f "$DATA/sparko.login" ]; then
 genkeys && printf "Generating new set of sparko keys ..."
fi

## Construct params string.
PARAMS="--conf=$CONF --network=$NETWORK --sparko-login=$(gen_logstr) --sparko-keys=$(gen_keystr) $@"

## Execute main binary.
echo "$PARAMS"
echo "Executing $CMD with params:"
for param in $PARAMS; do echo $param; done && echo

$CMD $PARAMS
